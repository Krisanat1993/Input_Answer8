<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</title>
    <!-- 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #F7F7F7;
            color: #333333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            min-height: 600px;
            position: relative;
        }
        .header {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        .content {
            padding: 40px 30px;
        }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .instruction-box {
            background: #F1F5F9;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border-left: 4px solid #3B82F6;
        }
        .instruction-box p {
            margin: 0;
            color: #475569;
            font-size: 1rem;
        }
        /* ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
        .form-group { margin-bottom: 32px; }
        
        .form-label {
            display: block;
            font-weight: 700; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î */
            margin-bottom: 16px;
            color: #111827; /* ‡∏™‡∏µ‡∏î‡∏≥‡πÄ‡∏Ç‡πâ‡∏° */
            font-size: 1.2rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.8;
            background-color: #F3F4F6; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3B82F6;
        }
        .dropdown select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }
        .dropdown select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-family: 'Sarabun', sans-serif;
        }
        .btn:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        .btn-primary {
            background: #3B82F6;
            color: white;
            width: 100%;
        }
        .btn-primary:hover:not(:disabled) {
            background: #2563EB;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-success {
            background: #16A34A;
            color: white;
            width: 100%;
        }
        .btn-success:hover:not(:disabled) {
            background: #15803D;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }
        .btn-back {
            background: transparent;
            color: #6B7280;
            padding: 8px 16px;
            font-size: 0.9rem;
            margin-bottom: 24px;
            border: 1px solid #E5E7EB;
            width: auto;
        }
        .btn-back:hover {
            background: #F9FAFB;
            color: #374151;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏û‡∏•‡∏≤‡∏î */
        #submitButton {
            margin-top: 60px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            padding: 16px 32px;
            font-size: 1.1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* New Styles for Dynamic Inputs */
        .btn-add {
            background-color: #F3F4F6;
            color: #4B5563;
            border: 2px dashed #D1D5DB;
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-add:hover {
            background-color: #E5E7EB;
            border-color: #9CA3AF;
            color: #1F2937;
        }
        .input-set {
            background: #fff;
            padding: 15px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
        }
        .input-set:nth-child(even) {
            background-color: #FAFAFA;
        }
        .sub-label {
            font-size: 0.9rem;
            color: #4B5563;
            margin-bottom: 6px;
            margin-top: 12px;
            font-weight: 500;
            display: block;
        }
        .main-label {
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
            display: block;
        }

        /* Styles for Login Section */
        .btn-line-login {
            background-color: #06C755;
            color: white;
            width: 100%;
            margin-bottom: 16px;
        }
        .btn-line-login:hover {
            background-color: #05b34c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 199, 85, 0.3);
        }
        .btn-guest {
            background-color: transparent;
            color: #6B7280;
            border: 1px solid #E5E7EB;
            width: 100%;
        }
        .btn-guest:hover {
            background-color: #F9FAFB;
        }

        .problem-statement {
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            background: #FAFAFA;
        }
        .problem-statement h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: #1F2937;
        }
        
        #problem-description {
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 50px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
            color: #374151; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
        }
        #problem-lesson {
             font-weight: 500; 
             margin-bottom: 1rem; 
             color: #1F2937;
             min-height: 24px;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-top: 24px;
        }
        .image-gallery img {
             width: 100%;
             height: auto;
             border-radius: 8px;
             background-color: #f3f4f6;
             object-fit: cover;
             border: 1px solid #e5e7eb;
        }
        .image-caption {
            font-style: italic;
            font-size: 0.875rem;
            color: #6B7280;
            margin-top: 8px;
            text-align: left;
        }
        
        /* --- ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Textarea ‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏î‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô --- */
        .textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Sarabun', sans-serif;
            line-height: 1.6;
            resize: vertical; 
            min-height: 120px; /* Reduced slightly for multi-input forms */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #FAFAFA; 
        }
        .textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            background-color: #FFFFFF;
        }
        
         .spinner {
            border: 4px solid rgba(0,0,0,.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3B82F6;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #1F2937;
        }
        .modal-message {
            color: #4B5563;
            margin-bottom: 20px;
            white-space: pre-wrap;
            text-align: left;
        }
        .modal-btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }
        .modal-btn:hover { background: #2563EB; }

        @media (max-width: 768px) {
            .container { margin: 10px; border-radius: 12px; }
            .header { padding: 30px 20px; }
            .header h1 { font-size: 2rem; }
            .content { padding: 30px 20px; }
        }
        @media (max-width: 480px) {
            .header h1 { font-size: 1.75rem; }
            .btn { width: 100%; padding: 14px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</h1>
        </div>
        <div class="content">
            <form id="questionnaireForm">
                <!-- Page 1: Participant Information -->
                <div id="page1" class="page active">
                     <div class="instruction-box">
                        <p>‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠</p>
                    </div>
                    
                    <div id="loader" style="text-align: center; padding: 2rem 0;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 1rem; color: #6b7280;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô Login ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Desktop -->
                    <div id="loginSection" style="display: none; text-align: center; padding: 20px 0;">
                        <h3 style="margin-bottom: 16px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <p style="margin-bottom: 24px; color: #6B7280;">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ</p>
                        <button type="button" id="lineLoginBtn" class="btn btn-line-login">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE
                        </button>
                        <!-- ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Guest ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ User ID ‡∏à‡∏£‡∏¥‡∏á -->
                        <button type="button" id="guestLoginBtn" class="btn btn-guest" style="font-size: 0.9em; display: none;">
                            ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (Guest Mode)
                        </button>
                    </div>

                    <div id="participantSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="participant">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                            <div class="dropdown">
                                <select id="participant" name="participant" required>
                                    <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà-‡∏¢‡∏®-‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</option>
                                </select>
                            </div>
                        </div>
                        <div id="errorMessage" style="display: none; color: #EF4444; background: #FEF2F2; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 1rem; border: 1px solid #FECACA;">
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        </div>
                        <button type="button" id="nextButton" class="btn btn-primary">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                    </div>
                </div>

                <!-- Page 2: Questions -->
                <div id="page2" class="page">
                    <button type="button" id="backButton" class="btn btn-back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
                    
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (Problem Statement) ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å GAS -->
                    <div class="problem-statement">
                        <h3>‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                        <!-- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet -->
                        <h4 id="problem-lesson">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠...</h4>
                        <p id="problem-description">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</p>
                        
                        <div class="image-gallery">
                            <!-- Image 1 -->
                            <div id="img-container-1" style="display:none;">
                                <img id="image1" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1" onerror="this.style.display='none'">
                                <p id="image1-caption" class="image-caption"></p>
                            </div>
                            <!-- Image 2 -->
                            <div id="img-container-2" style="display:none;">
                                <img id="image2" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 2" onerror="this.style.display='none'">
                                <p id="image2-caption" class="image-caption"></p>
                            </div>
                            <!-- Image 3 -->
                            <div id="img-container-3" style="display:none;">
                                <img id="image3" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 3" onerror="this.style.display='none'">
                                <p id="image3-caption" class="image-caption"></p>
                            </div>
                            <!-- Image 4 -->
                            <div id="img-container-4" style="display:none;">
                                <img id="image4" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4" onerror="this.style.display='none'">
                                <p id="image4-caption" class="image-caption"></p>
                            </div>
                            <!-- Image 5 -->
                            <div id="img-container-5" style="display:none;">
                                <img id="image5" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 5" onerror="this.style.display='none'">
                                <p id="image5-caption" class="image-caption"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Question 1: Label ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å GAS -->
                    <div class="form-group">
                        <label id="question1-label" class="form-label">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1 (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...)</label>
                        <div id="q1-container"></div>
                        <button type="button" id="add-q1-btn" class="btn btn-add">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                    </div>
                    
                    <!-- Question 2: Label ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å GAS -->
                    <div class="form-group">
                        <label id="question2-label" class="form-label">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2 (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...)</label>
                        <div id="q2-container"></div>
                        <button type="button" id="add-q2-btn" class="btn btn-add">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                    </div>
                    
                    <!-- Question 3: Label ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å GAS -->
                    <div class="form-group">
                        <label id="question3-label" class="form-label">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 3 (‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...)</label>
                        <div id="q3-container"></div>
                        <button type="button" id="add-q3-btn" class="btn btn-add">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                    </div>

                    <button type="submit" id="submitButton" class="btn btn-success">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" class="modal-title">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
            <div id="modalMessage" class="modal-message">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
            <button id="modalBtn" class="modal-btn">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <script>
        // Modal Helper
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalBtn = document.getElementById('modalBtn');

        function showModal(title, message, callback) {
            modalTitle.textContent = title;
            // Allow HTML in message for line breaks
            modalMessage.innerHTML = message;
            modal.classList.add('active');
            
            modalBtn.onclick = function() {
                modal.classList.remove('active');
                if (callback) callback();
            };
        }

        async function main() {
            // --- Elements ---
            const page1 = document.getElementById('page1');
            const page2 = document.getElementById('page2');
            const nextButton = document.getElementById('nextButton');
            const backButton = document.getElementById('backButton');
            const participantDropdown = document.getElementById('participant');
            const form = document.getElementById('questionnaireForm');
            const errorMessage = document.getElementById('errorMessage');
            const loader = document.getElementById('loader');
            const participantSection = document.getElementById('participantSection');
            const submitButton = document.getElementById('submitButton');
            
            // Login Elements
            const loginSection = document.getElementById('loginSection');
            const lineLoginBtn = document.getElementById('lineLoginBtn');
            const guestLoginBtn = document.getElementById('guestLoginBtn');

            // Dynamic Input Elements
            const q1Container = document.getElementById('q1-container');
            const q2Container = document.getElementById('q2-container');
            const q3Container = document.getElementById('q3-container');
            const addQ1Btn = document.getElementById('add-q1-btn');
            const addQ2Btn = document.getElementById('add-q2-btn');
            const addQ3Btn = document.getElementById('add-q3-btn');

            let q1Count = 0;
            let q2Count = 0;
            let q3Count = 0;

            // --- Function to Create Inputs ---
            function createQ1Input() {
                q1Count++;
                const div = document.createElement('div');
                div.className = 'input-set';
                div.innerHTML = `
                    <label class="main-label">${q1Count}.</label>
                    <textarea class="textarea q1-input" rows="3" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠ ${q1Count} ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                `;
                q1Container.appendChild(div);
            }

            function createQ2Input() {
                q2Count++;
                const div = document.createElement('div');
                div.className = 'input-set q2-set';
                div.innerHTML = `
                    <label class="main-label">${q2Count}. ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <textarea class="textarea q2-main" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å..."></textarea>
                    
                    <label class="sub-label">${q2Count}.1 ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea class="textarea q2-sub1" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢..."></textarea>
                    
                    <label class="sub-label">${q2Count}.2 ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                    <textarea class="textarea q2-sub2" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢..."></textarea>
                `;
                q2Container.appendChild(div);
            }

            function createQ3Input() {
                q3Count++;
                const div = document.createElement('div');
                div.className = 'input-set q3-set';
                div.innerHTML = `
                    <label class="main-label">${q3Count}. ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</label>
                    <textarea class="textarea q3-main" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå..."></textarea>
                    
                    <label class="sub-label">${q3Count}.1 ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ</label>
                    <textarea class="textarea q3-sub1" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å..."></textarea>
                    
                    <label class="sub-label">${q3Count}.2 ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏≤‡∏á‡∏ó‡∏´‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô</label>
                    <textarea class="textarea q3-sub2" rows="2" placeholder="‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á..."></textarea>
                `;
                q3Container.appendChild(div);
            }

            // --- Add Button Listeners ---
            addQ1Btn.addEventListener('click', createQ1Input);
            addQ2Btn.addEventListener('click', createQ2Input);
            addQ3Btn.addEventListener('click', createQ3Input);

            // --- Initialize First Inputs ---
            createQ1Input();
            createQ2Input();
            createQ3Input();


            // --- Configuration ---
            const LIFF_ID = '2008056238-g8p1R13n'; 
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbzmdsVjgV-h_KFOCGpnt1HeZ1FdJTyMGKq9f4K0FALVR1iCd2ai-holzFH-4FTIqv6I/exec';
            const SHEET_ID = '1Fn3Rn8pO43tYOQrKI_-oSmc-UxL6hog3JXZ2cYjsGYI';
            const SHEET_GID = '1799873089';
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;
            
            let lineUserId = '';
            let sheetData = [];
            let isLiffMode = false;

            // --- Initialize LIFF Logic ---
            const initializeApp = async () => {
                try {
                    // Fetch Data first
                    await fetchSheetData();

                    if (typeof liff !== 'undefined') {
                        await liff.init({ liffId: LIFF_ID });
                        
                        // Case 1: Already Logged In
                        if (liff.isLoggedIn()) {
                            const profile = await liff.getProfile();
                            lineUserId = profile.userId;
                            isLiffMode = true;
                            showParticipantSection();
                        } 
                        // Case 2: Not Logged In
                        else {
                            loader.style.display = 'none';
                            loginSection.style.display = 'block';
                            
                            lineLoginBtn.onclick = () => {
                                // Redirect to LINE Login
                                if (!liff.isInClient()) {
                                    liff.login(); 
                                } else {
                                    liff.login();
                                }
                            };
                            
                            guestLoginBtn.onclick = () => {
                                lineUserId = 'GUEST-' + Math.floor(Math.random() * 100000);
                                showParticipantSection();
                            }
                        }
                    } else {
                        throw new Error("LIFF SDK not loaded");
                    }
                } catch (error) {
                    console.warn('LIFF Init failed or Error:', error);
                    lineUserId = 'WEB-ERROR-USER';
                    showParticipantSection();
                }
            };

            const showParticipantSection = () => {
                loader.style.display = 'none';
                loginSection.style.display = 'none';
                participantSection.style.display = 'block';
            };

            // --- Helper Function for Google Drive Links ---
            function convertGoogleDriveLink(url) {
                if (!url) return '';
                if (!url.includes('drive.google.com')) return url;
                const match = url.match(/drive\.google\.com.*[?&]id=([a-zA-Z0-9_-]+)|file\/d\/([a-zA-Z0-9_-]+)/);
                const fileId = match ? (match[1] || match[2]) : null;
                return fileId ? `https://lh3.googleusercontent.com/d/${fileId}` : '';
            }

            // --- Fetch and Process Google Sheet Data ---
            async function fetchSheetData() {
                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    const jsonString = text.substring(47).slice(0, -2);
                    const json = JSON.parse(jsonString);
                    const rows = json.table.rows;

                    // Mapping Data based on User Request
                    sheetData = rows.map(row => ({
                        A: row.c[0]?.v || '', // Participant Name
                        B: row.c[1]?.v || '', // Lesson Title
                        C: row.c[2]?.v || '', // Problem Description
                        
                        D: row.c[3]?.v || '', // Image 1
                        E: row.c[4]?.v || '', // Caption 1
                        
                        F: row.c[5]?.v || '', // Image 2
                        G: row.c[6]?.v || '', // Caption 2
                        
                        H: row.c[7]?.v || '', // Image 3
                        I: row.c[8]?.v || '', // Caption 3
                        
                        J: row.c[9]?.v || '', // Image 4
                        K: row.c[10]?.v || '', // Caption 4
                        
                        L: row.c[11]?.v || '', // Image 5
                        M: row.c[12]?.v || '', // Caption 5

                        N: row.c[13]?.v || '', // Question 1 Label
                        O: row.c[14]?.v || '', // Question 2 Label
                        P: row.c[15]?.v || '', // Question 3 Label
                    }));

                    // Populate Dropdown
                    let hasOptions = false;
                    sheetData.forEach((row, index) => {
                        if (row.A) { 
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = row.A;
                            participantDropdown.appendChild(option);
                            hasOptions = true;
                        }
                    });
                    
                    if (!hasOptions) throw new Error("No participants found");

                } catch (error) {
                    console.error('Error fetching Google Sheet data:', error);
                    loader.innerHTML = `
                        <p style="color: #EF4444; font-weight: bold;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                        <button class="btn btn-back" onclick="location.reload()" style="margin-top:10px;">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                    `;
                }
            }
            
            // --- Update Page 2 Content ---
            function updateProblemContent(rowIndex) {
                const data = sheetData[rowIndex];
                if (!data) return;
                
                // --- PROBLEM STATEMENT UPDATE ---
                const lessonElem = document.getElementById('problem-lesson');
                const descElem = document.getElementById('problem-description');
                
                // ‡πÉ‡∏ä‡πâ TextContent ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ style.display='block' ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ
                if (lessonElem) {
                     lessonElem.textContent = data.B ? `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${data.B}` : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠';
                     lessonElem.style.display = 'block';
                }
                
                if (descElem) {
                     if (data.C && data.C.trim() !== "") {
                        descElem.textContent = data.C;
                        descElem.style.color = "#374151"; // ‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥
                     } else {
                        descElem.textContent = "(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤)";
                        descElem.style.color = "#9CA3AF"; // ‡∏™‡∏µ‡∏à‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                     }
                     descElem.style.display = 'block';
                }
                
                // Handle Images (1-5)
                const setupImage = (id, url, captionId, captionText, containerId) => {
                    const img = document.getElementById(id);
                    const container = document.getElementById(containerId);
                    const caption = document.getElementById(captionId);
                    const convertedUrl = convertGoogleDriveLink(url);
                    
                    // Reset first
                    container.style.display = 'none';

                    if (convertedUrl) {
                        img.src = convertedUrl;
                        img.style.display = 'block';
                        container.style.display = 'block';
                        caption.textContent = captionText || '';
                        caption.style.display = captionText ? 'block' : 'none';
                    }
                };

                setupImage('image1', data.D, 'image1-caption', data.E, 'img-container-1');
                setupImage('image2', data.F, 'image2-caption', data.G, 'img-container-2');
                setupImage('image3', data.H, 'image3-caption', data.I, 'img-container-3');
                setupImage('image4', data.J, 'image4-caption', data.K, 'img-container-4');
                setupImage('image5', data.L, 'image5-caption', data.M, 'img-container-5');

                // --- QUESTION LABELS UPDATE ---
                const q1Label = document.getElementById('question1-label');
                const q2Label = document.getElementById('question2-label');
                const q3Label = document.getElementById('question3-label');

                if (q1Label) q1Label.textContent = data.N || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1';
                if (q2Label) q2Label.textContent = data.O || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2';
                if (q3Label) q3Label.textContent = data.P || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 3';
            }

            // --- Navigation Logic ---
            nextButton.addEventListener('click', function() {
                const selectedIndex = participantDropdown.value;
                if (selectedIndex === "") {
                    errorMessage.style.display = 'block';
                    participantDropdown.parentElement.style.animation = "shake 0.5s";
                    setTimeout(() => participantDropdown.parentElement.style.animation = "", 500);
                } else {
                    errorMessage.style.display = 'none';
                    updateProblemContent(selectedIndex); // *** ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
                    page1.classList.remove('active');
                    page2.classList.add('active');
                    window.scrollTo(0, 0);
                }
            });

            backButton.addEventListener('click', function() {
                page2.classList.remove('active');
                page1.classList.add('active');
                window.scrollTo(0, 0);
            });
            
            // --- Form Submission Logic ---
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

                // --- 1. Gather Data ---
                const selectedOption = participantDropdown.options[participantDropdown.selectedIndex];
                const participantName = selectedOption ? selectedOption.textContent : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const selectedIndex = participantDropdown.value; 
                const lesson = document.getElementById('problem-lesson').textContent;
                
                // Helper to gather inputs
                const getQ1Answers = () => {
                    let text = '';
                    const inputs = document.querySelectorAll('.q1-input');
                    inputs.forEach((input, index) => {
                        const val = input.value.trim();
                        if (val) text += `${index + 1}. ${val}\n`;
                    });
                    return text || '-';
                };

                const getQ2Answers = () => {
                    let text = '';
                    const sets = document.querySelectorAll('.q2-set');
                    sets.forEach((set, index) => {
                        const main = set.querySelector('.q2-main').value.trim();
                        const sub1 = set.querySelector('.q2-sub1').value.trim();
                        const sub2 = set.querySelector('.q2-sub2').value.trim();
                        
                        if (main || sub1 || sub2) {
                            text += `${index + 1}. ${main || '-'}\n   ${index + 1}.1 ${sub1 || '-'}\n   ${index + 1}.2 ${sub2 || '-'}\n`;
                        }
                    });
                    return text || '-';
                };

                const getQ3Answers = () => {
                    let text = '';
                    const sets = document.querySelectorAll('.q3-set');
                    sets.forEach((set, index) => {
                        const main = set.querySelector('.q3-main').value.trim();
                        const sub1 = set.querySelector('.q3-sub1').value.trim();
                        const sub2 = set.querySelector('.q3-sub2').value.trim();
                        
                        if (main || sub1 || sub2) {
                            text += `${index + 1}. ${main || '-'}\n   ${index + 1}.1 ${sub1 || '-'}\n   ${index + 1}.2 ${sub2 || '-'}\n`;
                        }
                    });
                    return text || '-';
                };

                const answers = {
                    a1: getQ1Answers(),
                    a2: getQ2Answers(),
                    a3: getQ3Answers(),
                };

                const questions = {
                    q1: document.getElementById('question1-label').textContent,
                    q2: document.getElementById('question2-label').textContent,
                    q3: document.getElementById('question3-label').textContent,
                };

                const timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
                
                // Prepare Message
                const summaryMessage = `üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°
-------------------------
‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö: ${participantName}
User ID: ${lineUserId.startsWith('GUEST') ? 'Guest' : lineUserId.substring(0, 5) + '...'}
‡πÄ‡∏ß‡∏•‡∏≤: ${timestamp}
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: ${lesson}
-------------------------
1. ${questions.q1}
‡∏ï‡∏≠‡∏ö: 
${answers.a1}

2. ${questions.q2}
‡∏ï‡∏≠‡∏ö: 
${answers.a2}

3. ${questions.q3}
‡∏ï‡∏≠‡∏ö: 
${answers.a3}
-------------------------
‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏£‡πà‡∏ß‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°`;

                // --- 2. Send to GAS (Data Only) ---
                try {
                    const formData = new FormData();
                    formData.append('timestamp', timestamp);
                    formData.append('lineUserId', lineUserId);
                    formData.append('participant', participantName);
                    formData.append('lesson', lesson);
                    formData.append('q1', questions.q1); formData.append('a1', answers.a1);
                    formData.append('q2', questions.q2); formData.append('a2', answers.a2);
                    formData.append('q3', questions.q3); formData.append('a3', answers.a3);
                    
                    // *** Force Client-side Send ***
                    formData.append('pushMessage', 'false');
                    formData.append('messageContent', summaryMessage);

                    const response = await fetch(GAS_URL, {
                        method: 'POST',
                        body: formData,
                    });
                    
                    const result = await response.json();

                    if (result.result !== 'success') {
                         throw new Error('Script returned non-success result');
                    }

                    // --- 3. Try Sending Message via LIFF (Client-side) ---
                    try {
                        await liff.sendMessages([{ type: 'text', text: summaryMessage }]);
                        
                        if (liff.isInClient()) {
                            liff.closeWindow();
                        } else {
                            showModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', () => {
                                location.reload();
                            });
                        }
                    } catch (msgError) {
                        console.error("LIFF Send Error:", msgError);
                        let errorMsg = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ';
                        
                        if (!liff.isInClient()) {
                            errorMsg += '<br><br><small style="color:red">‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: liff.sendMessages ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡∏ô External Browser</small>';
                        }
                        
                        showModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)', errorMsg, () => {
                            if (liff.isInClient()) liff.closeWindow();
                            else location.reload();
                        });
                    }
                    
                } catch (error) {
                    console.error('Submission Error:', error);
                    showModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
                }
            });

            // Start App
            initializeApp();
        }

        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
