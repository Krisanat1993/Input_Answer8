<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #F7F7F7;
            color: #333333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            min-height: 600px;
            position: relative;
        }
        .header {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }
        .content { padding: 40px 30px; }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .instruction-box {
            background: #F1F5F9;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
            border-left: 4px solid #3B82F6;
        }
        .instruction-box p { margin: 0; color: #475569; font-size: 1rem; }
        .form-group { margin-bottom: 24px; }
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
            font-size: 1.1rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .dropdown select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #374151;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }
        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-family: 'Sarabun', sans-serif;
        }
        .btn:disabled { background-color: #9CA3AF; cursor: not-allowed; }
        .btn-primary { background: #3B82F6; color: white; width: 100%; }
        .btn-success { background: #16A34A; color: white; width: 100%; }
        .btn-back {
            background: transparent; color: #6B7280;
            padding: 8px 16px; font-size: 0.9rem;
            margin-bottom: 24px; border: 1px solid #E5E7EB; width: auto;
        }
        .btn-line-login { background-color: #06C755; color: white; width: 100%; margin-bottom: 16px; }
        .btn-guest { background-color: transparent; color: #6B7280; border: 1px solid #E5E7EB; width: 100%; }

        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡∏ö‡∏ô iOS */
            font-family: 'Sarabun', sans-serif;
            resize: vertical;
            min-height: 160px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô */
            line-height: 1.6;
            transition: border-color 0.3s ease;
        }
        .textarea:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .problem-statement {
            border: 1px solid #E5E7EB; border-radius: 12px;
            padding: 24px; margin-bottom: 32px; background: #FAFAFA;
        }
        .problem-statement h3 {
            font-family: 'Poppins', sans-serif; font-size: 1.25rem;
            font-weight: 600; margin-bottom: 16px; color: #1F2937;
        }
        .image-gallery {
            display: grid; grid-template-columns: 1fr; gap: 24px; margin-top: 24px;
        }
        .image-gallery img {
             width: 100%; height: auto; border-radius: 8px;
             background-color: #f3f4f6; object-fit: cover; border: 1px solid #e5e7eb;
        }
        .image-caption {
            font-style: italic; font-size: 0.875rem; color: #6B7280;
            margin-top: 8px; text-align: left;
        }
        .spinner {
            border: 4px solid rgba(0,0,0,.1); width: 36px; height: 36px;
            border-radius: 50%; border-left-color: #3B82F6; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 400px; text-align: center;
        }
        .modal-btn { background: #3B82F6; color: white; border: none; padding: 10px 24px; border-radius: 6px; width: 100%; }

        @media (max-width: 768px) {
            .container { margin: 10px; }
            .header h1 { font-size: 1.8rem; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header"><h1>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</h1></div>
        <div class="content">
            <form id="questionnaireForm">
                <!-- Page 1: Login & Participant Selection -->
                <div id="page1" class="page active">
                     <div class="instruction-box">
                        <p>‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ä‡∏µ‡πâ‡πÅ‡∏à‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô</p>
                    </div>
                    
                    <div id="loader" style="text-align: center; padding: 2rem 0;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 1rem; color: #6b7280;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>

                    <div id="loginSection" style="display: none; text-align: center; padding: 20px 0;">
                        <h3 style="margin-bottom: 16px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>
                        <button type="button" id="lineLoginBtn" class="btn btn-line-login">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE</button>
                        <button type="button" id="guestLoginBtn" class="btn btn-guest" style="font-size: 0.9em; display: none;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (Guest)</button>
                    </div>

                    <div id="participantSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="participant">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                            <div class="dropdown">
                                <select id="participant" name="participant" required>
                                    <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà-‡∏¢‡∏®-‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</option>
                                </select>
                            </div>
                        </div>
                        <div id="errorMessage" style="display: none; color: #EF4444; background: #FEF2F2; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 1rem; border: 1px solid #FECACA;">
                            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                        </div>
                        <button type="button" id="nextButton" class="btn btn-primary">‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
                    </div>
                </div>

                <!-- Page 2: Content (5 Images + 3 Questions) -->
                <div id="page2" class="page">
                    <button type="button" id="backButton" class="btn btn-back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
                    <div class="problem-statement">
                        <h3>‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤</h3>
                        <h4 id="problem-lesson" style="font-weight: 500; margin-bottom: 1rem; color: #374151;"></h4>
                        <p id="problem-description"></p>
                        <div class="image-gallery">
                            <div id="img-container-1" style="display:none;"><img id="image1" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1" onerror="this.style.display='none'"><p id="image1-caption" class="image-caption"></p></div>
                            <div id="img-container-2" style="display:none;"><img id="image2" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 2" onerror="this.style.display='none'"><p id="image2-caption" class="image-caption"></p></div>
                            <div id="img-container-3" style="display:none;"><img id="image3" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 3" onerror="this.style.display='none'"><p id="image3-caption" class="image-caption"></p></div>
                            <div id="img-container-4" style="display:none;"><img id="image4" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4" onerror="this.style.display='none'"><p id="image4-caption" class="image-caption"></p></div>
                            <div id="img-container-5" style="display:none;"><img id="image5" src="" alt="‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 5" onerror="this.style.display='none'"><p id="image5-caption" class="image-caption"></p></div>
                        </div>
                    </div>
                    
                    <div class="form-group"><label id="question1-label" for="answer1" class="form-label"></label><textarea id="answer1" class="textarea" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea></div>
                    <div class="form-group"><label id="question2-label" for="answer2" class="form-label"></label><textarea id="answer2" class="textarea" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea></div>
                    <div class="form-group"><label id="question3-label" for="answer3" class="form-label"></label><textarea id="answer3" class="textarea" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."></textarea></div>

                    <button type="submit" id="submitButton" class="btn btn-success">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle" class="modal-title"></h3>
            <div id="modalMessage" class="modal-message"></div>
            <button id="modalBtn" class="modal-btn">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <script>
        // Modal Helper
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalBtn = document.getElementById('modalBtn');

        function showModal(title, message, callback) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modal.classList.add('active');
            modalBtn.onclick = function() {
                modal.classList.remove('active');
                if (callback) callback();
            };
        }

        async function main() {
            // Elements
            const page1 = document.getElementById('page1');
            const page2 = document.getElementById('page2');
            const nextButton = document.getElementById('nextButton');
            const backButton = document.getElementById('backButton');
            const participantDropdown = document.getElementById('participant');
            const form = document.getElementById('questionnaireForm');
            const errorMessage = document.getElementById('errorMessage');
            const loader = document.getElementById('loader');
            const participantSection = document.getElementById('participantSection');
            const submitButton = document.getElementById('submitButton');
            const loginSection = document.getElementById('loginSection');
            const lineLoginBtn = document.getElementById('lineLoginBtn');
            const guestLoginBtn = document.getElementById('guestLoginBtn');

            // Config
            const LIFF_ID = '2008056238-g8p1R13n'; 
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbzmdsVjgV-h_KFOCGpnt1HeZ1FdJTyMGKq9f4K0FALVR1iCd2ai-holzFH-4FTIqv6I/exec';
            const SHEET_ID = '1Fn3Rn8pO43tYOQrKI_-oSmc-UxL6hog3JXZ2cYjsGYI';
            const SHEET_GID = '1799873089';
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;
            
            let lineUserId = '';
            let sheetData = [];

            // Init App
            const initializeApp = async () => {
                try {
                    await fetchSheetData();
                    if (typeof liff !== 'undefined') {
                        await liff.init({ liffId: LIFF_ID });
                        if (liff.isLoggedIn()) {
                            const profile = await liff.getProfile();
                            lineUserId = profile.userId;
                            showParticipantSection();
                        } else {
                            loader.style.display = 'none';
                            loginSection.style.display = 'block';
                            lineLoginBtn.onclick = () => liff.login();
                            guestLoginBtn.onclick = () => {
                                lineUserId = 'GUEST-' + Math.floor(Math.random() * 100000);
                                showParticipantSection();
                            }
                        }
                    } else { throw new Error("LIFF SDK not loaded"); }
                } catch (error) {
                    console.warn('Init Error:', error);
                    lineUserId = 'WEB-ERROR-USER';
                    showParticipantSection();
                }
            };

            const showParticipantSection = () => {
                loader.style.display = 'none';
                loginSection.style.display = 'none';
                participantSection.style.display = 'block';
            };

            function convertGoogleDriveLink(url) {
                if (!url || !url.includes('drive.google.com')) return url || '';
                const match = url.match(/drive\.google\.com.*[?&]id=([a-zA-Z0-9_-]+)|file\/d\/([a-zA-Z0-9_-]+)/);
                const fileId = match ? (match[1] || match[2]) : null;
                return fileId ? `https://lh3.googleusercontent.com/d/${fileId}` : '';
            }

            async function fetchSheetData() {
                try {
                    const response = await fetch(url);
                    const text = await response.text();
                    const jsonString = text.substring(47).slice(0, -2);
                    const json = JSON.parse(jsonString);
                    // Map Columns: A=Name, B=Title, C=Desc, D-M=Images, N-P=Questions
                    sheetData = json.table.rows.map(row => ({
                        A: row.c[0]?.v || '', // Name
                        B: row.c[1]?.v || '', // Title
                        C: row.c[2]?.v || '', // Desc
                        D: row.c[3]?.v || '', // Img1
                        E: row.c[4]?.v || '', // Cap1
                        F: row.c[5]?.v || '', // Img2
                        G: row.c[6]?.v || '', // Cap2
                        H: row.c[7]?.v || '', // Img3
                        I: row.c[8]?.v || '', // Cap3
                        J: row.c[9]?.v || '', // Img4
                        K: row.c[10]?.v || '', // Cap4
                        L: row.c[11]?.v || '', // Img5
                        M: row.c[12]?.v || '', // Cap5
                        N: row.c[13]?.v || '', // Q1
                        O: row.c[14]?.v || '', // Q2
                        P: row.c[15]?.v || ''  // Q3
                    }));

                    let hasOptions = false;
                    sheetData.forEach((row, index) => {
                        if (row.A) { 
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = row.A;
                            participantDropdown.appendChild(option);
                            hasOptions = true;
                        }
                    });
                    if (!hasOptions) throw new Error("No data");
                } catch (error) {
                    console.error('Fetch Error:', error);
                    loader.innerHTML = `<p style="color:red">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p><button class="btn btn-back" onclick="location.reload()">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>`;
                }
            }
            
            function updateProblemContent(rowIndex) {
                const data = sheetData[rowIndex];
                if (!data) return;
                document.getElementById('problem-lesson').textContent = data.B ? `‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${data.B}` : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠';
                document.getElementById('problem-description').textContent = data.C || '';
                
                const setupImage = (id, url, captionId, captionText, containerId) => {
                    const img = document.getElementById(id);
                    const container = document.getElementById(containerId);
                    const convertedUrl = convertGoogleDriveLink(url);
                    if (convertedUrl) {
                        img.src = convertedUrl; container.style.display = 'block';
                        document.getElementById(captionId).textContent = captionText;
                    } else { container.style.display = 'none'; }
                };

                // Display 5 Images
                setupImage('image1', data.D, 'image1-caption', data.E, 'img-container-1');
                setupImage('image2', data.F, 'image2-caption', data.G, 'img-container-2');
                setupImage('image3', data.H, 'image3-caption', data.I, 'img-container-3');
                setupImage('image4', data.J, 'image4-caption', data.K, 'img-container-4');
                setupImage('image5', data.L, 'image5-caption', data.M, 'img-container-5');

                // Display 3 Questions
                document.getElementById('question1-label').textContent = data.N || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1';
                document.getElementById('question2-label').textContent = data.O || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 2';
                document.getElementById('question3-label').textContent = data.P || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 3';
            }

            nextButton.addEventListener('click', function() {
                if (participantDropdown.value === "") {
                    errorMessage.style.display = 'block';
                } else {
                    errorMessage.style.display = 'none';
                    updateProblemContent(participantDropdown.value);
                    page1.classList.remove('active');
                    page2.classList.add('active');
                    window.scrollTo(0, 0);
                }
            });

            backButton.addEventListener('click', function() {
                page2.classList.remove('active');
                page1.classList.add('active');
                window.scrollTo(0, 0);
            });
            
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                submitButton.disabled = true;
                submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

                const selectedOption = participantDropdown.options[participantDropdown.selectedIndex];
                const participantName = selectedOption ? selectedOption.textContent : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                const lesson = document.getElementById('problem-lesson').textContent;
                
                // Get 3 Questions
                const q1 = document.getElementById('question1-label').textContent;
                const q2 = document.getElementById('question2-label').textContent;
                const q3 = document.getElementById('question3-label').textContent;

                // Get 3 Answers
                const a1 = document.getElementById('answer1').value.trim() || '-';
                const a2 = document.getElementById('answer2').value.trim() || '-';
                const a3 = document.getElementById('answer3').value.trim() || '-';

                const timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
                
                const summaryMessage = `üìù ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°
-------------------------
‡∏ú‡∏π‡πâ‡∏ï‡∏≠‡∏ö: ${participantName}
ID: ${lineUserId.startsWith('GUEST') ? 'Guest' : lineUserId.substring(0, 5) + '...'}
‡πÄ‡∏ß‡∏•‡∏≤: ${timestamp}
${lesson}
-------------------------
1. ‡∏à‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏à‡∏ô‡∏≤‡∏£‡∏°‡∏ì‡πå...
‡∏ï‡∏≠‡∏ö: ${a1}

2. ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞...
‡∏ï‡∏≠‡∏ö: ${a2}

3. ‡∏à‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå...
‡∏ï‡∏≠‡∏ö: ${a3}
-------------------------`;

                try {
                    const formData = new FormData();
                    formData.append('timestamp', timestamp);
                    formData.append('lineUserId', lineUserId);
                    formData.append('participant', participantName);
                    formData.append('lesson', lesson);
                    formData.append('q1', q1); formData.append('a1', a1);
                    formData.append('q2', q2); formData.append('a2', a2);
                    formData.append('q3', q3); formData.append('a3', a3);
                    formData.append('pushMessage', 'false');
                    formData.append('messageContent', summaryMessage);

                    const response = await fetch(GAS_URL, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.result !== 'success') throw new Error('Script Error');

                    try {
                        await liff.sendMessages([{ type: 'text', text: summaryMessage }]);
                        if (liff.isInClient()) liff.closeWindow();
                        else showModal('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', () => location.reload());
                    } catch (msgError) {
                        let errorMsg = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
                        if (!liff.isInClient()) errorMsg += '<br><small style="color:red">Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</small>';
                        showModal('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', errorMsg, () => {
                            if (liff.isInClient()) liff.closeWindow();
                            else location.reload();
                        });
                    }
                } catch (error) {
                    console.error('Submission Error:', error);
                    showModal('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    submitButton.disabled = false;
                    submitButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö';
                }
            });

            initializeApp();
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
